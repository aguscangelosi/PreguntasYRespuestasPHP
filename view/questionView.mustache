<div class="text-center bg-light-subtle">
    <h1 class="p-3">Pregunta</h1>

    <p class="fs-3 fw-semibold">{{enunciado}}</p>
    <p class="fw-bold">Dificultad: {{dificultad}}</p>

    <p class="fs-6 fw-medium">Selecciona la respuesta</p>
    <ul id="respuestas" class="list-group">
        {{#respuestas}}
            <li>
                <div class="d-grid gap-2 col-6 mx-auto">
                    <button id="answer-{{answer_id}}" class="btn btn-outline-dark p-3 m-1 respuesta-btn" onclick="sendQuestion({{answer_id}})">
                        {{texto_respuesta}}
                    </button>
                </div>
            </li>
        {{/respuestas}}
    </ul>
</div>

<div id="resultado" style="display: flex; justify-content: center; align-items: center; padding-bottom: 10px;flex-direction: column"></div>
<input type="hidden" value="{{idMatch}}" id="idMatch">
<input type="hidden" value="{{question_id}}" id="question_id">

<script>
    async function sendQuestion(selectedAnswerId) {
        let idMatch = document.getElementById('idMatch').value;
        let idQuestion = document.getElementById('question_id').value;

        let data = new FormData();
        data.append('idMatch', idMatch);
        data.append('idQuestion', idQuestion);
        data.append('idResponse', selectedAnswerId);

        try {
            let response = await fetch('/PreguntasYRespuestasPHP/game/sendQuestion', {
                method: 'POST',
                body: data
            });

            if (!response.ok) {
                throw new Error('Error en la solicitud');
            }

            let result = await response.json();

            if (result.error === 'timeout') {
                let buttons = document.querySelectorAll('.respuesta-btn');
                buttons.forEach(button => {
                    button.disabled = true;
                    button.classList.remove('btn-outline-dark');
                    button.classList.add('btn-danger');
                });

                document.getElementById('resultado').innerHTML = '<p class="text-danger">El tiempo para responder ha expirado.</p>';

                let actionButton = document.createElement('a');
                actionButton.classList.add('btn', 'btn-danger', 'mt-3');
                actionButton.href = `/PreguntasYRespuestasPHP/game/finish?idMatch=${idMatch}`;
                actionButton.innerText = 'Finalizar partida';
                document.getElementById('resultado').appendChild(actionButton);

                return;
            }

            let correctAnswerId = result.answer_id;
            let correct = result.correct;

            let buttons = document.querySelectorAll('.respuesta-btn');
            buttons.forEach(button => {
                button.disabled = true;

                let answerId = button.id.split('-')[1];
                if (parseInt(answerId) === correctAnswerId) {
                    button.classList.remove('btn-outline-dark');
                    button.classList.add('btn-success');
                } else if (parseInt(answerId) === selectedAnswerId) {
                    button.classList.remove('btn-outline-dark');
                    button.classList.add('btn-danger');
                }
            });

            let actionButton = document.createElement('a');
            actionButton.classList.add('btn', 'mt-3');
            actionButton.href = correct ? `/PreguntasYRespuestasPHP/game/playAgain?idMatch=${idMatch}` : `/PreguntasYRespuestasPHP/game/finish?idMatch=${idMatch}`;
            actionButton.innerText = correct ? 'Continuar' : 'Finalizar partida';
            actionButton.classList.add(correct ? 'btn-primary' : 'btn-danger');

            document.getElementById('resultado').appendChild(actionButton);

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('resultado').innerHTML = '<p class="text-danger">Error al enviar la respuesta.</p>';
        }
    }
</script>

